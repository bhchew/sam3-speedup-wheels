name: Build CUDA 12.4 + PyTorch 2.5.1

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  CUDA_VERSION: '12.4'
  PYTORCH_VERSION: '2.5.1'
  TORCH_CUDA_ARCH_LIST: '7.5;8.6;8.9;9.0'

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    container:
      image: nvidia/cuda:12.4.0-devel-ubuntu22.04
    env:
      CUDA_HOME: /usr/local/cuda
    strategy:
      fail-fast: false
      matrix:
        package: [torch_generic_nms, cc_torch]
        python: ['3.10', '3.11', '3.12']

    steps:
      - name: Free disk space
        run: |
          df -h
          apt-get remove -y --purge '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk google-chrome-stable firefox powershell mono-devel || true
          apt-get autoremove -y || true
          apt-get clean || true
          rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* || true
          rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache || true
          df -h

      - uses: actions/checkout@v4

      - name: Install Python ${{ matrix.python }}
        run: |
          apt-get update
          apt-get install -y software-properties-common git curl
          add-apt-repository -y ppa:deadsnakes/ppa
          apt-get update
          apt-get install -y python${{ matrix.python }} python${{ matrix.python }}-venv python${{ matrix.python }}-dev
          curl -sS https://bootstrap.pypa.io/get-pip.py | python${{ matrix.python }}
          update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.python }} 1
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.python }} 1

      - name: Install PyTorch and build tools
        run: |
          python -m pip install --upgrade pip
          # Install CUDA PyTorch then remove bundled NVIDIA libs (we have system CUDA)
          python -m pip install torch==${{ env.PYTORCH_VERSION }}+cu124 --index-url https://download.pytorch.org/whl/cu124
          pip uninstall -y nvidia-cublas-cu12 nvidia-cuda-nvrtc-cu12 nvidia-cuda-runtime-cu12 nvidia-cudnn-cu12 nvidia-cufft-cu12 nvidia-curand-cu12 nvidia-cusolver-cu12 nvidia-cusparse-cu12 nvidia-nccl-cu12 nvidia-nvtx-cu12 nvidia-nvjitlink-cu12 nvidia-cufile-cu12 nvidia-cuda-cupti-cu12 || true
          python -m pip install wheel setuptools ninja

      - name: Verify setup
        run: |
          nvcc --version
          python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.version.cuda}')"

      - name: Clone and build ${{ matrix.package }}
        run: |
          if [ "${{ matrix.package }}" = "torch_generic_nms" ]; then
            git clone https://github.com/ronghanghu/torch_generic_nms.git
          else
            git clone https://github.com/ronghanghu/cc_torch.git
          fi
          cd ${{ matrix.package }}
          python setup.py bdist_wheel
          ls -la dist/

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-linux-cu124-torch251-py${{ matrix.python }}
          path: ${{ matrix.package }}/dist/*.whl
          retention-days: 90

  build-windows:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        package: [torch_generic_nms, cc_torch]
        python: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Download CUDA network installer
        shell: powershell
        run: |
          $installerUrl = "https://developer.download.nvidia.com/compute/cuda/12.4.1/network_installers/cuda_12.4.1_windows_network.exe"
          Write-Host "Downloading CUDA 12.4 network installer (~31MB)..."
          Invoke-WebRequest -Uri $installerUrl -OutFile "cuda_installer.exe" -UseBasicParsing

      - name: Install CUDA toolkit
        shell: powershell
        run: |
          Write-Host "Installing CUDA toolkit..."
          Start-Process -FilePath "cuda_installer.exe" -ArgumentList "-s", "-n", "nvcc_12.4", "cudart_12.4", "cusparse_dev_12.4", "cublas_dev_12.4", "curand_dev_12.4", "cufft_dev_12.4", "cusolver_dev_12.4", "thrust_12.4", "nvtx_12.4" -Wait -NoNewWindow
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4"
          if (Test-Path "$cudaPath\bin\nvcc.exe") {
            Write-Host "CUDA installed successfully"
          } else {
            Write-Host "WARNING: nvcc.exe not found"
            Get-ChildItem "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\" -ErrorAction SilentlyContinue
          }
          echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "CUDA_HOME=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CUDA_PATH=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install PyTorch
        shell: bash
        run: |
          pip install torch==${{ env.PYTORCH_VERSION }}+cu124 --index-url https://download.pytorch.org/whl/cu124
          pip install wheel setuptools ninja

      - name: Verify setup
        run: |
          nvcc --version
          python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.version.cuda}')"

      - name: Clone ${{ matrix.package }}
        run: |
          if ("${{ matrix.package }}" -eq "torch_generic_nms") {
            git clone https://github.com/ronghanghu/torch_generic_nms.git
          } else {
            git clone https://github.com/ronghanghu/cc_torch.git
          }

      - name: Build wheel
        shell: cmd
        run: |
          cd ${{ matrix.package }}
          set TORCH_CUDA_ARCH_LIST=7.5;8.6;8.9;9.0
          python setup.py bdist_wheel
          dir dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-windows-cu124-torch251-py${{ matrix.python }}
          path: ${{ matrix.package }}/dist/*.whl
          retention-days: 90

  collect:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true

      - name: List all wheels
        run: find wheels -name "*.whl" -type f | sort

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-cu124-torch251-wheels
          path: wheels/*.whl
          retention-days: 90
