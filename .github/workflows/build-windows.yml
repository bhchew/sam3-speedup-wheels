name: Build Windows Wheels

on:
  workflow_dispatch:
    inputs:
      cuda_version:
        description: 'CUDA version'
        required: true
        default: '12.1'
        type: choice
        options: ['11.8', '12.1', '12.4']
      pytorch_version:
        description: 'PyTorch version'
        required: true
        default: '2.4.0'
        type: string

jobs:
  build:
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        package: [torch_generic_nms, cc_torch]
        python: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Get CUDA version info
        id: cuda
        shell: bash
        run: |
          CUDA_VER="${{ inputs.cuda_version }}"
          echo "version=$CUDA_VER" >> $GITHUB_OUTPUT
          echo "version_nodot=${CUDA_VER//.}" >> $GITHUB_OUTPUT

      - name: Setup CUDA ${{ inputs.cuda_version }}
        uses: Jimver/cuda-toolkit@v0.2.16
        with:
          cuda: '${{ inputs.cuda_version }}'
          method: 'network'

      - name: Install PyTorch
        shell: bash
        run: |
          CUDA_TAG="cu${{ steps.cuda.outputs.version_nodot }}"
          pip install torch==${{ inputs.pytorch_version }}+${CUDA_TAG} --index-url https://download.pytorch.org/whl/${CUDA_TAG}
          pip install wheel setuptools ninja

      - name: Verify setup
        run: |
          nvcc --version
          python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.version.cuda}')"

      - name: Clone torch_generic_nms
        if: matrix.package == 'torch_generic_nms'
        run: git clone https://github.com/ronghanghu/torch_generic_nms.git

      - name: Clone cc_torch
        if: matrix.package == 'cc_torch'
        run: git clone https://github.com/ronghanghu/cc_torch.git

      - name: Build wheel
        shell: cmd
        run: |
          cd ${{ matrix.package }}
          set TORCH_CUDA_ARCH_LIST=7.0;7.5;8.0;8.6;8.9;9.0
          python setup.py bdist_wheel
          dir dist

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-windows-cu${{ steps.cuda.outputs.version_nodot }}-py${{ matrix.python }}
          path: ${{ matrix.package }}/dist/*.whl
          retention-days: 90

  collect:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true

      - name: List all wheels
        run: find wheels -name "*.whl" -type f | sort

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-windows-wheels-cu${{ inputs.cuda_version }}
          path: wheels/*.whl
          retention-days: 90
