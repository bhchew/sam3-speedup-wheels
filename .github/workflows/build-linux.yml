name: Build Linux Wheels

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      cuda_version:
        description: 'CUDA version'
        required: true
        default: '12.1'
        type: choice
        options: ['11.8', '12.1', '12.4']
      pytorch_version:
        description: 'PyTorch version'
        required: true
        default: '2.4.0'
        type: string
      python_version:
        description: 'Python version'
        required: true
        default: '3.11'
        type: choice
        options: ['3.10', '3.11', '3.12']

env:
  DEFAULT_CUDA: '12.1'
  DEFAULT_PYTORCH: '2.4.0'
  DEFAULT_PYTHON: '3.11'

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        package: [torch_generic_nms, cc_torch]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || env.DEFAULT_PYTHON }}

      - name: Get version info
        id: versions
        run: |
          CUDA_VER="${{ inputs.cuda_version || env.DEFAULT_CUDA }}"
          CUDA_NODOT=$(echo $CUDA_VER | tr -d '.')
          # For apt package (e.g., 12.1 -> 12-1)
          CUDA_APT=$(echo $CUDA_VER | tr '.' '-')
          echo "cuda=$CUDA_VER" >> $GITHUB_OUTPUT
          echo "cuda_nodot=$CUDA_NODOT" >> $GITHUB_OUTPUT
          echo "cuda_apt=$CUDA_APT" >> $GITHUB_OUTPUT

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Install CUDA toolkit
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get -y install cuda-toolkit-${{ steps.versions.outputs.cuda_apt }}
          echo "/usr/local/cuda-${{ steps.versions.outputs.cuda }}/bin" >> $GITHUB_PATH
          echo "CUDA_HOME=/usr/local/cuda-${{ steps.versions.outputs.cuda }}" >> $GITHUB_ENV

      - name: Install PyTorch and build tools
        run: |
          PYTORCH_VER="${{ inputs.pytorch_version || env.DEFAULT_PYTORCH }}"
          CUDA_TAG="cu${{ steps.versions.outputs.cuda_nodot }}"
          pip install torch==${PYTORCH_VER}+${CUDA_TAG} --index-url https://download.pytorch.org/whl/${CUDA_TAG}
          pip install wheel setuptools ninja

      - name: Verify setup
        run: |
          nvcc --version
          python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.version.cuda}')"

      - name: Clone ${{ matrix.package }}
        run: |
          if [ "${{ matrix.package }}" = "torch_generic_nms" ]; then
            git clone https://github.com/ronghanghu/torch_generic_nms.git
          else
            git clone https://github.com/ronghanghu/cc_torch.git
          fi

      - name: Build wheel
        run: |
          cd ${{ matrix.package }}
          export TORCH_CUDA_ARCH_LIST="7.0;7.5;8.0;8.6;8.9;9.0"
          python setup.py bdist_wheel
          ls -la dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-linux-cu${{ steps.versions.outputs.cuda_nodot }}-py${{ inputs.python_version || env.DEFAULT_PYTHON }}
          path: ${{ matrix.package }}/dist/*.whl
          retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true

      - name: List wheels
        run: find wheels -name "*.whl" -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: wheels/*.whl
          generate_release_notes: true
